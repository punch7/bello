<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bello ‚Äî Zegar</title>
  <style>
    html,body {
      height:100%; margin:0;
      background:#FAFAF8;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }
    .wrap { height:100%; display:grid; place-items:center; }
    canvas { width:min(92vmin, 720px); height:min(92vmin, 720px); }
    .status {
      position:fixed; left:12px; right:12px; bottom:12px;
      text-align:center; color:#666; font-size:14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="clock" width="800" height="800"></canvas>
  </div>
  <div class="status" id="status">≈Åadowanie‚Ä¶</div>

  <script>
    // Tw√≥j endpoint z n8n:
    const WEBHOOK_URL = "https://punch7.app.n8n.cloud/webhook/bello/events";

    const canvas = document.getElementById("clock");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");

    let segments = [];
    let dialAnchorMinutes = 0;

    // --- POBIERANIE DANYCH ---
    async function fetchData() {
      statusEl.textContent = "Od≈õwie≈ºam‚Ä¶";
      try {
        const res = await fetch(WEBHOOK_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        segments = Array.isArray(data) ? data : [];
        dialAnchorMinutes = segments[0]?.dialAnchorMinutes ?? 0;
        statusEl.textContent = `OK: ${segments.length} wydarze≈Ñ ‚Ä¢ ${new Date().toLocaleTimeString()}`;
        draw();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "B≈ÇƒÖd pobierania danych (sprawd≈∫ CORS/URL)";
      }
    }

    // --- FUNKCJE POMOCNICZE ---
    function polar(cx, cy, r, a) {
      return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
    }

    function getHMInTZ(date, timeZone) {
      const parts = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false, timeZone
      }).formatToParts(date);
      const h = Number(parts.find(p => p.type === "hour").value);
      const m = Number(parts.find(p => p.type === "minute").value);
      const s = Number(parts.find(p => p.type === "second").value);
      return { h, m, s };
    }

    // --- RYSOWANIE ---
    function draw() {
      const W = canvas.width = canvas.clientWidth;
      const H = canvas.height = canvas.clientHeight;
      const cx = W / 2, cy = H / 2;

      const R = Math.min(W, H) * 0.46;
      const rIcon = R * 0.82;

      ctx.clearRect(0, 0, W, H);

      // t≈Ço
      ctx.fillStyle = "#FFFFFF";
      ctx.beginPath();
      ctx.arc(cx, cy, R + 10, 0, Math.PI * 2);
      ctx.fill();

      // ticki godzinowe
      ctx.strokeStyle = "#E6E2DC";
      ctx.lineWidth = Math.max(1.5, Math.min(W, H) * 0.003);
      for (let i = 0; i < 12; i++) {
        const a = (i / 12) * Math.PI * 2 - Math.PI / 2;
        const p0 = polar(cx, cy, R * 0.96, a);
        const p1 = polar(cx, cy, R, a);
        ctx.beginPath(); ctx.moveTo(p0.x, p0.y); ctx.lineTo(p1.x, p1.y); ctx.stroke();
      }

      // WYCIƒòCIA (pe≈Çne wedge)
      for (const s of segments) {
        let a0 = s.startAngle, a1 = s.endAngle;
        if (a1 <= a0) a1 += Math.PI * 2;

        const p0 = polar(cx, cy, R, a0);
        const p1 = polar(cx, cy, R, a1);

        ctx.save();
        ctx.globalAlpha = s.status === "past" ? 0.35 : s.status === "now" ? 1 : 0.9;
        ctx.fillStyle = s.color || "#ddd";
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(p0.x, p0.y);
        ctx.arc(cx, cy, R, a0, a1);
        ctx.closePath();
        ctx.fill();
        ctx.restore();

        // emoji
        const mid = (a0 + a1) / 2;
        const ip = polar(cx, cy, rIcon, mid);
        ctx.font = `${Math.round(Math.min(W, H) * 0.06)}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(s.icon || "üîÜ", ip.x, ip.y);
      }

      // WSKAZ√ìWKI CZASU (ET)
      const now = new Date();
      const { h, m, s } = getHMInTZ(now, "America/New_York");
      const nowMinDial = (h % 12) * 60 + m + s / 60;
      const shiftedMin = ((nowMinDial - dialAnchorMinutes) % 720 + 720) % 720;

      const aHr = (shiftedMin / 720) * Math.PI * 2 - Math.PI / 2;
      const aMn = ((m + s / 60) / 60) * Math.PI * 2 - Math.PI / 2;

      ctx.strokeStyle = "#222";
      // godzinna
      ctx.lineWidth = Math.max(4, Math.min(W, H) * 0.012);
      ctx.beginPath(); ctx.moveTo(cx, cy);
      ctx.lineTo(cx + (R * 0.52) * Math.cos(aHr), cy + (R * 0.52) * Math.sin(aHr)); ctx.stroke();
      // minutowa
      ctx.lineWidth = Math.max(3, Math.min(W, H) * 0.008);
      ctx.beginPath(); ctx.moveTo(cx, cy);
      ctx.lineTo(cx + (R * 0.8) * Math.cos(aMn), cy + (R * 0.8) * Math.sin(aMn)); ctx.stroke();

      // pin
      ctx.fillStyle = "#222";
      ctx.beginPath();
      ctx.arc(cx, cy, Math.min(W, H) * 0.015, 0, Math.PI * 2);
      ctx.fill();
    }

    // --- HARMONOGRAM ---
    fetchData();
    setInterval(fetchData, 60_000);
    setInterval(draw, 1_000);
  </script>
</body>
</html>
