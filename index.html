<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bello — Zegar</title>
  <style>
    :root{
      /* fallback — zostaną nadpisane po wczytaniu tokenów */
      --bg: #FAFAF8;
      --sky-top: #6A8ACF;
      --sky-bottom: #F0B4A8;
      --text-on-sky: #FFFFFF;
      --card-radius: 32px;
      --card-shadow: 0 14px 40px rgba(20, 25, 40, 0.25);
    }

    html, body { height:100%; margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif }

    .app { min-height:100%; display:grid; place-items:center; padding:24px; }

    .clock-card{
      position: relative;
      width: min(92vw, 820px);
      aspect-ratio: 1 / 1;
      border-radius: var(--card-radius);
      overflow: hidden;
      box-shadow: var(--card-shadow);
      background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bottom) 70%);
      display:grid;
      place-items:center;
    }

    /* Cyfrowy czas — czytelny na jasnym tle */
    .time{
      position:absolute;
      top:6%;
      left:50%;
      transform:translateX(-50%);
      font-weight:800;
      letter-spacing:0.5px;
      color:var(--text-on-sky);
      font-size:clamp(28px, 6vw, 54px);
      user-select:none; -webkit-user-select:none;
      padding:6px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.18);
      backdrop-filter:saturate(120%) blur(2px);
      line-height:1;
    }

    .dial-wrap{
      width:min(86vmin, 720px);
      max-width:92%;
      aspect-ratio:1/1;
      display:grid;
      place-items:center;
    }
    canvas { width:100%; height:100%; }

    .status{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      text-align:center;
      color:rgba(255,255,255,.95);
      font-size:14px;
      text-shadow:0 1px 0 rgba(0,0,0,.25);
      user-select:none; -webkit-user-select:none;
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="clock-card" aria-label="Zegar rytmu dnia">
      <div class="time" id="timeDisplay">--:--</div>
      <div class="dial-wrap">
        <canvas id="clock" width="800" height="800" aria-label="Tarcza zegara"></canvas>
      </div>
      <div class="status" id="status">Ładowanie…</div>
    </section>
  </main>

  <script>
    // ─────────────────────────────────────────────────────────────
    // TOKENS → CSS vars (gradient/kolory)
    // ─────────────────────────────────────────────────────────────
    async function applyTokens(){
      try{
        const res = await fetch('./data/bello-tokens.json', { cache:'no-store' });
        if(!res.ok) throw new Error('tokens HTTP '+res.status);
        const t = await res.json();

        // podstawowe kolory
        document.documentElement.style.setProperty('--bg', t.colors?.bg ?? '#FAFAF8');
        document.documentElement.style.setProperty('--text-on-sky', t.colors?.text?.base ?? '#FFFFFF');
        document.documentElement.style.setProperty('--sky-top', t.colors?.illustration?.skyTop ?? '#6A8ACF');
        document.documentElement.style.setProperty('--sky-bottom', t.colors?.illustration?.skyBottom ?? '#F0B4A8');

        // promień/cień karty (jeśli są w tokenach)
        if (t.radii?.xl)   document.documentElement.style.setProperty('--card-radius', t.radii.xl + 'px');
        if (t.shadows?.card) document.documentElement.style.setProperty('--card-shadow', t.shadows.card);
      }catch(e){
        console.warn('Tokeny: używam fallbacków', e);
      }
    }

    // ─────────────────────────────────────────────────────────────
    // DANE z n8n
    // ─────────────────────────────────────────────────────────────
    const WEBHOOK_URL = "https://punch7.app.n8n.cloud/webhook/bello/events";

    const canvas   = document.getElementById('clock');
    const ctx      = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const timeEl   = document.getElementById('timeDisplay');

    let segments = [];
    let dialAnchorMinutes = 0; // 0..719

    async function fetchData() {
      statusEl.textContent = 'Odświeżam…';
      try {
        const res = await fetch(WEBHOOK_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        segments = Array.isArray(data) ? data : [];
        const rawAnchor = segments[0]?.dialAnchorMinutes ?? 0;
        dialAnchorMinutes = Number(rawAnchor) || 0;
        dialAnchorMinutes = ((dialAnchorMinutes % 720) + 720) % 720;

        const { h, m, s } = getHMInTZ(new Date(), 'America/New_York');
        const hh = String(h).padStart(2,'0'), mm = String(m).padStart(2,'0'), ss = String(s).padStart(2,'0');
        statusEl.textContent = `OK: ${segments.length} wydarzeń • ${hh}:${mm}:${ss} ET`;

        draw();
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Błąd pobierania danych (sprawdź CORS/URL)';
      }
    }

    // ─────────────────────────────────────────────────────────────
    // HELPERY
    // ─────────────────────────────────────────────────────────────
    function polar(cx, cy, r, a) { return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) }; }

    function getHMInTZ(date, timeZone) {
      const parts = new Intl.DateTimeFormat('en-US', {
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false, timeZone
      }).formatToParts(date);
      const h = Number(parts.find(p => p.type === 'hour').value);
      const m = Number(parts.find(p => p.type === 'minute').value);
      const s = Number(parts.find(p => p.type === 'second').value);
      return { h, m, s };
    }

    // ─────────────────────────────────────────────────────────────
    // RYSOWANIE
    // ─────────────────────────────────────────────────────────────
    function draw() {
      const W = canvas.width = canvas.clientWidth;
      const H = canvas.height = canvas.clientHeight;
      const cx = W/2, cy = H/2;

      const R     = Math.min(W,H) * 0.46; // promień tarczy
      const rIcon = R * 0.82;             // promień dla emoji

      ctx.clearRect(0,0,W,H);

      // tło tarczy
      ctx.fillStyle = '#FFFFFF';
      ctx.beginPath();
      ctx.arc(cx, cy, R + 10, 0, Math.PI*2);
      ctx.fill();

      // ticki co 1h
      ctx.strokeStyle = '#E6E2DC';
      ctx.lineWidth = Math.max(1.5, Math.min(W,H)*0.003);
      for (let i=0;i<12;i++){
        const a = (i/12)*Math.PI*2 - Math.PI/2;
        const p0 = polar(cx, cy, R*0.96, a);
        const p1 = polar(cx, cy, R, a);
        ctx.beginPath(); ctx.moveTo(p0.x, p0.y); ctx.lineTo(p1.x, p1.y); ctx.stroke();
      }

      // segmenty — korygujemy względem zakotwiczenia 12h okna
      const anchorOffset = (dialAnchorMinutes / 720) * Math.PI * 2;

      for (const s of segments) {
        let a0 = s.startAngle + anchorOffset;
        let a1 = s.endAngle + anchorOffset;
        if (a1 <= a0) a1 += Math.PI*2;

        const p0 = polar(cx, cy, R, a0);

        ctx.save();
        ctx.globalAlpha = s.status === 'past' ? 0.35 : s.status === 'now' ? 1 : 0.9;
        ctx.fillStyle = s.color || '#ddd';

        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(p0.x, p0.y);
        ctx.arc(cx, cy, R, a0, a1);
        ctx.closePath();
        ctx.fill();
        ctx.restore();

        // emoji
        const mid = (a0 + a1) / 2;
        const ip = polar(cx, cy, rIcon, mid);
        ctx.font = `${Math.round(Math.min(W,H)*0.06)}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(s.icon || '🔆', ip.x, ip.y);
      }

      // czas ET
      const now = new Date();
      const { h, m, s } = getHMInTZ(now, 'America/New_York');
      timeEl.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

      const nowMinDial = (h % 12) * 60 + m + s/60;
      const aHr = (nowMinDial / 720) * Math.PI*2 - Math.PI/2;
      const aMn = ((m + s/60) / 60) * Math.PI*2 - Math.PI/2;

      ctx.strokeStyle = '#222';

      // godzinna
      ctx.lineWidth = Math.max(4, Math.min(W,H)*0.012);
      ctx.beginPath(); ctx.moveTo(cx,cy);
      ctx.lineTo(cx + (R*0.52)*Math.cos(aHr), cy + (R*0.52)*Math.sin(aHr)); ctx.stroke();

      // minutowa
      ctx.lineWidth = Math.max(3, Math.min(W,H)*0.008);
      ctx.beginPath(); ctx.moveTo(cx,cy);
      ctx.lineTo(cx + (R*0.8)*Math.cos(aMn), cy + (R*0.8)*Math.sin(aMn)); ctx.stroke();

      // pin
      ctx.fillStyle = '#222';
      ctx.beginPath(); ctx.arc(cx, cy, Math.min(W,H)*0.015, 0, Math.PI*2); ctx.fill();
    }

    // ─────────────────────────────────────────────────────────────
    // BOOT
    // ─────────────────────────────────────────────────────────────
    (async function boot(){
      await applyTokens();
      fetchData();
      setInterval(fetchData, 60_000); // dane co minutę
      setInterval(draw, 1_000);       // wskazówki + cyfrowy czas co sekundę
    })();
  </script>
</body>
</html>
